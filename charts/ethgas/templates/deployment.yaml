apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "ethgas.fullname" . }}
  {{- with $.Values.namespaceOverride }}
  namespace: {{ . }}
  {{- end }}
  labels:
    {{- include "ethgas.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "ethgas.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      {{- with .Values.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      labels:
        {{- include "ethgas.labels" . | nindent 8 }}
        {{- with .Values.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "ethgas.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      initContainers:
      - name: init-gen-jwt
        image: ghcr.io/ethgas-developer/commitboost_gen_jwt:v1.0.0-beta.5
        env:
        - name: CB_MODULE_ID
          value: ETHGAS_COMMIT
        volumeMounts:
        - name: env
          mountPath: /app
      - name: init
        image: "{{ .Values.image.initContainer.repository }}:{{ .Values.image.initContainer.tag }}"
        command: ['sh', '-c', 'printenv | grep CB_; find /app/; cat /app/.cb.env; chmod 777 -R /var/logs/commit-boost/; cat /cb-config.toml']
        envFrom:
        - configMapRef:
            name: {{ include "ethgas.fullname" . }}-env-vars
        volumeMounts:
        - name: logs-pbs
          mountPath: /var/logs/commit-boost/logs-pbs
        - name: logs-signer
          mountPath: /var/logs/commit-boost/logs-signer
        - name: logs-ethgas-commit
          mountPath: /var/logs/commit-boost/logs-ethgas-commit
        - name: env
          mountPath: /app
        - name: config
          mountPath: /cb-config.toml
          subPath: config.toml
      containers:
        - name: pbs
          image: "{{ .Values.image.pbs.repository }}:{{ .Values.image.pbs.tag }}"
          ports:
          - containerPort: {{ .Values.service.port.pbs.http }}
          - containerPort: {{ .Values.service.port.pbs.metrics }}
          env:
          - name: CB_CONFIG
            value: /cb-config.toml
          - name: CB_PBS_ENDPOINT
            value: 0.0.0.0:{{ .Values.service.port.pbs.http }}
          - name: CB_METRICS_PORT
            value: "{{ .Values.service.port.pbs.metrics }}"
          - name: CB_LOGS_DIR
            value: /var/logs/commit-boost
#          envFrom:
#          - configMapRef:
#              name: {{ include "ethgas.fullname" . }}-env-vars
          volumeMounts:
          - name: config
            mountPath: /cb-config.toml
            subPath: config.toml
          - name: logs-pbs
            mountPath: /var/logs/commit-boost
        - name: signer
          image: "{{ .Values.image.signer.repository }}:{{ .Values.image.signer.tag }}"
          ports:
          - containerPort: {{ .Values.service.port.signer.http }}
          - containerPort: {{ .Values.service.port.signer.metrics }}
          env:
          - name: CB_CONFIG
            value: /cb-config.toml
          - name: CB_SIGNER_ENDPOINT
            value: 0.0.0.0:{{ .Values.service.port.signer.http }}
          - name: CB_METRICS_PORT
            value: "{{ .Values.service.port.signer.metrics }}"
          - name: CB_LOGS_DIR
            value: /var/logs/commit-boost
          envFrom:
          - configMapRef:
              name: {{ include "ethgas.fullname" . }}-env-vars
          volumeMounts:
          - name: config
            mountPath: /cb-config.toml
            subPath: config.toml
          - name: env
            mountPath: /app
          - name: keys
            mountPath: /keys
          - name: logs-signer
            mountPath: /var/logs/commit-boost
          - name: signer-secrets
            mountPath: "/signer/secrets"
            readOnly: true
        - name: ethgas-commit
          image: "{{ .Values.image.ethgas_commit.repository }}:{{ .Values.image.ethgas_commit.tag }}"
          command: ["/bin/sh"]
          args:
          - -c
          - while true; do /usr/local/bin/ethgas_commit; sleep 3600; done
          ports:
          - containerPort: {{ .Values.service.port.ethgas_commit.metrics }}
          env:
          - name: CB_MODULE_ID
            value: ETHGAS_COMMIT
          - name: CB_CONFIG
            value: /cb-config.toml
          - name: CB_SIGNER_URL
            value: http://localhost:{{ .Values.service.port.signer.http }}
          - name: CB_METRICS_PORT
            value: "{{ .Values.service.port.ethgas_commit.metrics }}"
          - name: CB_LOGS_DIR
            value: /var/logs/commit-boost
          envFrom:
          - configMapRef:
              name: {{ include "ethgas.fullname" . }}-env-vars
          volumeMounts:
          - name: config
            mountPath: /cb-config.toml
            subPath: config.toml
          - name: env
            mountPath: /app
          - name: logs-ethgas-commit
            mountPath: /var/logs/commit-boost
      volumes:
        - name: config
          configMap:
            name: {{ include "ethgas.fullname" . }}
        - name: env
          emptyDir: {}
        - name: logs-pbs
          persistentVolumeClaim:
            claimName: {{ include "ethgas.fullname" . }}-pbs-logs
        - name: logs-signer
          persistentVolumeClaim:
            claimName: {{ include "ethgas.fullname" . }}-signer-logs
        - name: logs-ethgas-commit
          persistentVolumeClaim:
            claimName: {{ include "ethgas.fullname" . }}-commit-logs
        - name: keys
          persistentVolumeClaim:
            claimName: {{ include "ethgas.fullname" . }}-signer-keys
        - name: signer-secrets
          secret:
            secretName: {{ include "ethgas.fullname" . }}-signer
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
