suite: httproute tests

set:
  fullnameOverride: some-full-name
  HTTPRoute:
    enabled: true

templates:
  - httproute.yaml

tests:
  - it: given a backend ref with only port configured then should default to the chart's service with default weight
    set:
      HTTPRoute:
        rules:
          - backendRefs:
            - port: 8080
    asserts:
      - equal:
          path: .spec.rules[0].backendRefs[0]
          value:
            group: ""
            kind: Service
            name: some-full-name
            port: 8080
            weight: 1
  - it: given a backend ref with overrides then should use overrides
    set:
      HTTPRoute:
        rules:
          - backendRefs:
              - group: some.customresource.io
                kind: Potato
                name: foo
                namespace: bar
                port: 1234
                weight: 999
    asserts:
      - equal:
          path: .spec.rules[0].backendRefs[0]
          value:
            group: some.customresource.io
            kind: Potato
            name: foo
            namespace: bar
            port: 1234
            weight: 999

  - it: given service with exactly one port then backendRef should be optional and use that port
    set:
      service:
        ports:
          - name: test
            port: 1234
            protocol: TCP
      HTTPRoute:
        rules:
          - matches:
              - path:
                  type: Exact
                  value: /foo
    asserts:
      - equal:
          path: .spec.rules[0].matches[0]
          value:
            path:
              type: Exact
              value: /foo
      - equal:
         path: .spec.rules[0].backendRefs[0]
         value:
           group: ""
           kind: Service
           name: some-full-name
           port: 1234
           weight: 1

  - it: given service with numbers of ports different than one then backendRefs should not be optional
    set:
      service:
        ports:
          - name: test
            port: 1234
            protocol: TCP
          - name: test2
            port: 4321
            protocol: TCP
      HTTPRoute:
        rules:
          - matches:
              - path:
                  type: Exact
                  value: /foo
    asserts:
      - failedTemplate:
          errorMessage: 'The Service was configured with 2 ports, therefore all HTTPRoute rules must manually specify backendRefs'
