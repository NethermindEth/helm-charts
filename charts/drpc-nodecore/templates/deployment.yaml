{{- range $projectName, $projectConfig := .Values.projects }}
{{- $ctx := dict "root" $ "projectName" $projectName }}
{{- $defaults := $.Values.defaults }}
{{- $deployment := $projectConfig.deployment | default $defaults.deployment }}
{{- $autoscaling := $deployment.autoscaling | default $defaults.deployment.autoscaling }}
{{- if $deployment.enabled | default $defaults.deployment.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "drpc-nodecore.projectName" $ctx }}
  labels:
    {{- include "drpc-nodecore.projectLabels" $ctx | nindent 4 }}
spec:
  {{- with $deployment.strategy | default $defaults.deployment.strategy }}
  strategy:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  revisionHistoryLimit: 3
  {{- if not $autoscaling.enabled }}
  replicas: {{ $projectConfig.replicaCount | default $defaults.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "drpc-nodecore.projectSelectorLabels" $ctx | nindent 6 }}
  template:
    metadata:
      annotations:
        {{- if $deployment.restartOnChanges | default $defaults.deployment.restartOnChanges }}
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") $ | sha256sum }}
        {{- end }}
      labels:
        {{- include "drpc-nodecore.projectLabels" $ctx | nindent 8 }}
    spec:
      {{- with $.Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      securityContext:
        {{- toYaml ($projectConfig.podSecurityContext | default $defaults.podSecurityContext) | nindent 8 }}
      terminationGracePeriodSeconds: {{ $projectConfig.terminationGracePeriodSeconds | default $defaults.terminationGracePeriodSeconds }}

      initContainers:
        - name: envsubst
          image: "{{ $.Values.initImage.repository }}:{{ $.Values.initImage.tag }}"
          command:
            - sh
            - -c
            - |
              envsubst < /etc/nodecore-raw/nodecore.yaml > /etc/nodecore-config/nodecore.yaml
          envFrom:
            - secretRef:
                name: {{ required (printf "secretRef is required for project %s" $projectName) $projectConfig.secretRef }}
            {{- with $projectConfig.envFrom }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
          {{- with $projectConfig.env }}
          env:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          volumeMounts:
            - name: nodecore-config-raw
              mountPath: /etc/nodecore-raw
            - name: nodecore-config
              mountPath: /etc/nodecore-config
          securityContext:
            {{- toYaml ($projectConfig.initContainerSecurityContext | default $defaults.initContainerSecurityContext) | nindent 12 }}

      containers:
        - name: nodecore
          image: "{{ $.Values.image.repository }}:{{ $.Values.image.tag | default $.Chart.AppVersion }}"
          imagePullPolicy: {{ $.Values.image.pullPolicy }}
          ports:
            - name: rpc
              containerPort: 9090
            - name: metrics
              containerPort: 9093
          securityContext:
            {{- toYaml ($projectConfig.securityContext | default $defaults.securityContext) | nindent 12 }}
          envFrom:
            - secretRef:
                name: {{ $projectConfig.secretRef }}
            {{- with $projectConfig.envFrom }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
          {{- with $projectConfig.env }}
          env:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          livenessProbe:
            {{- toYaml ($projectConfig.livenessProbe | default $defaults.livenessProbe) | nindent 12 }}
          readinessProbe:
            {{- toYaml ($projectConfig.readinessProbe | default $defaults.readinessProbe) | nindent 12 }}
          resources:
            {{- toYaml ($projectConfig.resources | default $defaults.resources) | nindent 12 }}
          volumeMounts:
            - name: nodecore-config
              mountPath: /app/nodecore.yml
              subPath: nodecore.yaml

      {{- with $projectConfig.nodeSelector | default $defaults.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $projectConfig.affinity | default $defaults.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $projectConfig.tolerations | default $defaults.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      volumes:
        - name: nodecore-config-raw
          configMap:
            name: {{ include "drpc-nodecore.projectName" $ctx }}-config
        - name: nodecore-config
          emptyDir: {}
{{- end }}
{{- end }}
